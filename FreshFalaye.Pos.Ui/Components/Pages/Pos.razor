@page "/pos"
@using FreshFalaye.Pos.Shared.Abstractions
@inject IReceiptPrinter ReceiptPrinter
@implements IDisposable
@* @rendermode InteractiveServer *@



@inject ScaleService Scale
@inject DialogService DialogService
@inject IDbContextFactory<PosDbContext> DbFactory
@* @inject PosDbContext Db *@
@inject BillNumberService BillNoService
@inject PosApiService Api
@inject PosSaleService SaleService
@inject PosAuthService Auth
@inject NavigationManager Nav
@inject PosSyncService SyncService
@inject NotificationService NotificationService
@inject ApiSettings ApiSettings
@inject IJSRuntime JS


<RadzenNotification />
<RadzenDialog />

<div tabindex="0"
     @onkeydown="HandleKeyDown"
     class="container-fluid">

     @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-danger">
            <b>DEBUG:</b>
            <pre>@error</pre>
        </div>
    }

    @if (isSyncing)
    {
        <div class="pos-sync-overlay">
            <div class="sync-box">
                <div class="spinner-border text-light mb-3" role="status"></div>
                <h5>Syncing data…</h5>
                <p>Please wait</p>
            </div>
        </div>
    }
    else
    {

        <!-- ================= HEADER ================= -->
        @if (Auth.IsInitialized && Auth.CurrentUser != null)
        {
            <div class="pos-header mb-2">

                <!-- ROW 1: USER / BILL / ACTIONS -->
                <div class="row align-items-center">
                    <div class="col-md-4">
                        👤 <b>@Auth.CurrentUser.Username</b>
                        <span class="role">(@Auth.CurrentUser.Role)</span>
                    </div>

                    <div class="col-md-4 text-center">
                        <b>Bill No:</b> @billNo
                        @* <b>Weight:</b> @WeightText *@
                    </div>

                    <div class="col-md-4 text-end">
                        <button type="button"
                                class="btn btn-sm btn-primary me-2"
                                disabled="@isSyncing"
                                @onclick="SyncNow">
                            @(isSyncing ? "Syncing..." : "Sync")
                        </button>

                        <button type="button"
                                class="btn btn-sm btn-danger"
                                @onclick="Logout">
                            Logout
                        </button>
                    </div>
                </div>

                <!-- ROW 2: POS MENU -->
                <div class="row mt-1">
                    <div class="col-12">

                        @*  <button class="btn btn-sm btn-outline-secondary me-1"
                                disabled>
                            🧾 POS
                        </button>
 *@
                        <button class="btn btn-sm btn-outline-secondary me-1"
                                @onclick='() => Nav.NavigateTo("/pos-sales-today")'>
                            <b style="color:#ef8993">📋 Today Sales</b>
                        </button>

                        <button class="btn btn-sm btn-outline-secondary me-1"
                                @onclick='() => Nav.NavigateTo("/pos-day-summary")'>
                            <b style="color:#ef8993">📊 Day Summary</b>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-1"
                                @onclick='() => Nav.NavigateTo("/unsynced-sales")'>
                            <b style="color:#ef8993">📊 Unsynced Sales</b>
                        </button>

                    </div>
                </div>
            </div>
            @* <div class="row pos-header align-items-center mb-2">
            <div class="col-md-4">
                👤 <b>@Auth.CurrentUser.Username</b>
                <span class="role">(@Auth.CurrentUser.Role)</span>
            </div>

            <div class="col-md-4 text-center">
                <b>Bill No:</b> @billNo
            </div>

            <div class="col-md-4 text-end">
                <button type="button" class="btn btn-sm btn-primary me-2"
                        disabled="@isSyncing"
                        @onclick="SyncNow">
                    @(isSyncing ? "Syncing..." : "Sync")
                </button>

                <button type="button" class="btn btn-sm btn-danger"
                        @onclick="Logout">
                    Logout
                </button>
            </div>
        </div> *@
        }

        <!-- ================= SALE HEADER ================= -->
        <div class="row g-2 mb-2">
            <div class="col-md-2">
                <label>Date</label>
                <input type="date" class="form-control form-control-sm"
                       @onfocusin="() => isInputFocused = true"
                       @onfocusout="() => isInputFocused = false"
                       @bind="saleDate" />
            </div>

            <div class="col-md-2">
                <label>Bill No</label>
                <input class="form-control form-control-sm"
                       @onfocusin="() => isInputFocused = true"
                       @onfocusout="() => isInputFocused = false"
                       value="@billNo" disabled />
            </div>

            <div class="col-md-2">
                <label>Payment</label>
                <select class="form-select form-select-sm" @ref="paymentModeRef"
                        @onfocusin="() => isInputFocused = true"
                        @onfocusout="() => isInputFocused = false"
                        @bind="paymentMode">
                    <option></option>
                    <option>Cash</option>
                    <option>UPI</option>
                    <option>Card</option>
                </select>
            </div>

            <div class="col-md-3">
                <label>Customer Mobile</label>
                @*  <input class="form-control form-control-sm"
                       @ref="customerMobileRef"
                       @onfocusin="() => isInputFocused = true"
                       @onfocusout="() => isInputFocused = false"
                       @bind="customerMobile" /> *@


                <div style="position:relative;">
                    <input class="form-control form-control-sm"
                           @ref="customerMobileRef"
                           @bind="customerMobile"
                           @bind:event="oninput"
                           @bind:after="OnMobileInput"
                           @onfocusin="() => isInputFocused = true"
                           @onfocusout="HideMobileSuggestionsDelayed" />


                    @if (showMobileSuggestions && mobileSuggestions.Any())
                    {
                        <div class="pos-suggestion-box">
                            @for (int i = 0; i < mobileSuggestions.Count; i++)
                            {
                                var s = mobileSuggestions[i];

                                <div class="pos-suggestion-item @(i == selectedSuggestionIndex ? "active" : "")"
                                     @onclick="() => SelectMobileSuggestion(s.Mobile, s.Name)">
                                    <b>@s.Mobile</b> - @s.Name
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <div class="col-md-3">
                <label>Customer Name</label>
                <input class="form-control form-control-sm"
                       @ref="customerNameRef"
                       @onfocusin="() => isInputFocused = true"
                       @onfocusout="() => isInputFocused = false"
                       @bind="customerName" />
            </div>
        </div>

        <!-- ================= PRODUCT GROUP FILTER ================= -->
        <div class="row">
            <!-- LEFT: PRODUCTS -->


            <div class="col-md-6 pos-left">
                <!-- Product Groups -->
                <div class="row mb-2">
                    <div class="col-12 group-filter">
                        <button class="btn btn-sm btn-secondary me-1
                                               @(selectedGroupId == Guid.Empty ? "active" : "")"
                                @onclick="() => SelectGroup(Guid.Empty)">
                            All
                        </button>

                        @foreach (var g in productGroups)
                        {
                            <button class="btn btn-sm btn-secondary me-1
                                                                           @(selectedGroupId == g.ProductGroupId ? "active" : "")"
                                    @onclick="() => SelectGroup(g.ProductGroupId)">
                                @g.GroupName
                            </button>
                        }
                    </div>
                </div>
                <!-- Product Search -->
                <div class="row mb-2">
                    <div class="col-12">
                        <input type="text"
                               class="form-control form-control-sm"
                               placeholder="🔍 Search product..."
                               @ref="productSearchRef"
                               @bind="productSearch"
                               @bind:event="oninput"
                               @onfocusin="() => isInputFocused = true"
                               @onfocusout="() => isInputFocused = false" />
                    </div>
                </div>

                <!-- Product Grid -->
                <div class="row pos-product-grid">
                    @foreach (var p in FilteredProducts)
                    {
                        <div class="col-6 col-md-3 col-lg-2 mb-2">
                            <div class="product-tile"
                                 @onclick="() => AddToCart(p)">
                                @if (!string.IsNullOrEmpty(p.ImagePath))
                                {
                                    @* <img src="@p.ImagePath" /> *@
                                    <img src="@(p.Base64Image ?? "/images/no-image.png")" />
                                    @* <img src="@GetProductImageUrl(p)"
                                         onerror="this.src='/images/no-image.png'" /> *@
                                }
                                <div class="product-name">@p.ProductName</div>
                                <div class="product-price">
                                    ₹ @p.SalePrice / @p.SecondaryUnitName
                                </div>
                                <div class="product-stock @(p.AvailableQty <= 0 ? "out-of-stock" : "")">
                                    Stock: @p.AvailableQty.ToString("0.##")
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>


            <!-- RIGHT: CART + EXPENSES -->
            <div class="col-md-6 pos-right">
                <!-- CART -->
                <div class="card pos-cart mb-2">
                    <div class="card-header py-1">
                        <b>Cart</b>
                    </div>
                    <div class="card-body p-1 cart-items">
                        @if (!cart.Any())
                        {
                            <p class="text-muted">No items added</p>
                        }
                        else
                        {
                            <table class="table table-sm table-bordered mb-0">
                                <thead>
                                    <tr>
                                        <th width="140px">Item</th>
                                        <th width="80px">Unit</th>
                                        <th width="70px">Qty</th>
                                        <th width="60px">Dis%</th>
                                        <th width="60px">Mrp</th>
                                        <th width="80px">Rate</th>
                                        <th width="90px">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in cart)
                                    {
                                        <tr class="@(item == selectedItem ? "table-primary" : "")"
                                            @onclick="() => SelectCartItem(item)">
                                            <td>@item.ProductName</td>
                                            <td>
                                                <select class="form-select form-select-sm"
                                                        @bind="item.UnitId"
                                                        @bind:after="() => OnUnitChanged(item)">
                                                    @foreach (var u in item.AvailableUnits)
                                                    {
                                                        <option value="@u.Id">@u.UnitCode</option>
                                                    }
                                                </select>
                                            </td>

                                            <td>
                                                <input type="number"
                                                       disabled="@item.UseWeighingScale"
                                                       class="form-control form-control-sm"
                                                       step="@(item.DecimalAllowed ? "0.001" : "1")"
                                                       value="@item.Qty"
                                                       @onchange="e => UpdateQty(item, e)" />
                                            </td>
                                            <td>@item.Discount</td>
                                            <td>@item.Mrp</td>
                                            <td>
                                                <input type="number"
                                                       class="form-control form-control-sm"
                                                       step="@(item.DecimalAllowed ? "0.00" : "0")"
                                                       value="@item.Rate"
                                                       @onchange="e => UpdateRate(item, e)" />
                                            </td>
                                            @* <td>@item.Rate</td> *@
                                            <td>@item.LineTotal.ToString("0.00")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>

                    <div class="card-footer cart-footer">
                        <div class="cart-total">
                            ₹ @GrandTotal.ToString("0.00")
                        </div>
                        <button class="btn btn-success w-100 mt-2"
                                disabled="@isSaving"
                                @onclick="SaveBill">
                            @(isSaving ? "Saving..." : "💾 Save (F2)")
                        </button>
                    </div>
                </div>
                <!-- EXPENSES -->
                <div class="card">
                    <div class="card-header py-1">
                        <b>Expenses</b>
                    </div>
                    <div class="card-body p-1">
                        @if (!expenses.Any())
                        {
                            <p class="text-muted">No sale expenses defined</p>
                        }
                        else
                        {
                            <table class="table table-sm table-bordered">
                                <tr>
                                    <th></th>
                                    <th>Expense</th>
                                    <th>Bearer</th>
                                    <th>Amount</th>
                                </tr>

                                @foreach (var exp in expenses)
                                {
                                    <tr>
                                        <td>
                                            <input type="checkbox"
                                                   @onfocusin="() => isInputFocused = true"
                                                   @onfocusout="() => isInputFocused = false"
                                                   @bind="exp.IsSelected"
                                                   @bind:after="RecalculateExpenses" />
                                        </td>
                                        <td>@exp.ExpenseName</td>
                                        <td>@exp.Bearer</td>
                                        <td>@exp.CalculatedAmount.ToString("0.00")</td>
                                    </tr>
                                }
                            </table>
                        }
                    </div>
                </div>
            </div>



        </div>

        <!-- ================= ACTION BAR ================= -->
        <div class="row mt-3 pos-actions">
            <div class="col-12 text-end">
                @* <button type="button" class="btn btn-success btn-lg me-2"
                    @onclick="SaveBill">
                💾 Save (F2)
            </button> *@

                <span class="text-danger ms-2">@error</span>
                <span class="text-success ms-2">@success</span>
            </div>
        </div>

    }


</div>











@code {

    class ExpenseVm
    {
        public Guid ExpenseId { get; set; }
        public string ExpenseName { get; set; } = null!;
        public string RateType { get; set; } = null!;
        public decimal Rate { get; set; }
        public string Bearer { get; set; } = null!;
        public string AddDeduct { get; set; }
        public bool IsSelected { get; set; }
        public decimal CalculatedAmount { get; set; }
    }

    List<ExpenseVm> expenses = new();

    bool authChecked = false;
    bool isSyncing = false;
    string productSearch = "";

    ElementReference customerMobileRef;
    ElementReference customerNameRef;
    ElementReference paymentModeRef;



    // ================= SALE HEADER =================
    DateTime saleDate = DateTime.Today;
    string billNo = "";
    string paymentMode = "";
    string? customerMobile;
    string? customerName;

    int selectedSuggestionIndex = -1;

    List<LocalProductGroup> productGroups = new();
    Guid selectedGroupId = Guid.Empty;

    string error = "";
    string success = "";

    bool isInputFocused = false;
    bool isSaving = false;

    CartItem? selectedItem;

    ElementReference productSearchRef;


    List<(string Mobile, string Name)> mobileSuggestions = new();
    bool showMobileSuggestions = false;

    // ================= DATA =================
    List<LocalProduct> products = new();
    List<CartItem> cart = new();

    //   IEnumerable<LocalProduct> FilteredProducts =>
    // selectedGroupId == 0
    //     ? products
    //     : products.Where(p => p.ProductGroupId == selectedGroupId);

    IEnumerable<LocalProduct> FilteredProducts =>
      products.Where(p =>
          (selectedGroupId == Guid.Empty || p.ProductGroupId == selectedGroupId) &&
          (string.IsNullOrWhiteSpace(productSearch) ||
           p.ProductName.Contains(productSearch, StringComparison.OrdinalIgnoreCase))
      );

    protected override async Task OnInitializedAsync()
    {

        try
        {
            error = "STEP 1: start init";

            Auth.AuthStateChanged += OnAuthStateChanged;

            error = "STEP 2: create db";
            await using var Db = await DbFactory.CreateDbContextAsync();

            error = "STEP 3: load settings";
            var setting = await Db.LocalSettings.FirstOrDefaultAsync();

            error = "STEP 4: scale start";
            string port = setting?.WeighingScaleComPortName ?? "COM4";
            int baud = setting?.WeighingScaleBudRate ?? 9600;

            if (!Scale.IsRunning)
            {
                try
                {
                    Scale.Start(port, baud);
                }
                catch (Exception)
                {
                    ShowError("Weighing machine not started. Please check if it si connected or not.");
                }
            }



            billNo = await BillNoService.PeekNextBillNoAsync();

            await LoadProductGroups();
            await LoadProducts();
            await LoadExpenses();
        }
        catch (Exception ex)
        {
            ShowError($"Error : {ex.Message}");
        }



    }

    async Task OnMobileInput()
    {
        if (string.IsNullOrWhiteSpace(customerMobile) ||
            customerMobile.Length < 3)
        {
            mobileSuggestions.Clear();
            showMobileSuggestions = false;
            return;
        }
        await using var Db = await DbFactory.CreateDbContextAsync();

        var matches = await Db.LocalSales
            .Where(x => x.CustomerMobile != null &&
                        x.CustomerMobile.Contains(customerMobile))
            .GroupBy(x => new { x.CustomerMobile, x.CustomerName })
            .Select(g => new
            {
                Mobile = g.Key.CustomerMobile,
                Name = g.Key.CustomerName
            })
            .OrderBy(x => x.Mobile)
            .Take(5)
            .ToListAsync();

        mobileSuggestions = matches
            .Select(x => (x.Mobile!, x.Name!))
            .ToList();

        showMobileSuggestions = mobileSuggestions.Any();
        selectedSuggestionIndex = -1;
    }


    async Task HideMobileSuggestionsDelayed()
    {
        await Task.Delay(200);
        showMobileSuggestions = false;
    }

    void SelectMobileSuggestion(string mobile, string name)
    {
        customerMobile = mobile;
        customerName = name;

        mobileSuggestions.Clear();
        showMobileSuggestions = false;
    }




    async Task LoadProductGroups()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        productGroups = await Db.LocalProductGroups.Where(p => p.IsActive).ToListAsync();
    }


    async Task LoadProducts()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        var productsWithStock = await (
            from p in Db.LocalProducts
            where p.IsActive
            join s in Db.LocalStocks
                on p.ProductId equals s.ProductId
                into stockGroup
            from s in stockGroup.DefaultIfEmpty()
            select new
            {
                Product = p,
                StockQty = s != null ? s.Qty : 0
            }
        ).ToListAsync();

        products = productsWithStock.Select(x =>
        {
            x.Product.AvailableQty = x.StockQty;
            return x.Product;
        }).ToList();

        // Load images
        foreach (var p in products)
        {
            if (!string.IsNullOrEmpty(p.ImagePath) && File.Exists(p.ImagePath))
            {
                var bytes = File.ReadAllBytes(p.ImagePath);
                p.Base64Image = $"data:image/jpeg;base64,{Convert.ToBase64String(bytes)}";
            }
        }
    }



    // async Task LoadProducts()
    // {
    //     products = await Db.LocalProducts
    //         .Where(p => p.IsActive)
    //         .ToListAsync();


    //     foreach (var p in products)
    //     {
    //         if (!string.IsNullOrEmpty(p.ImagePath) && File.Exists(p.ImagePath))
    //         {
    //             var bytes = File.ReadAllBytes(p.ImagePath);
    //             p.Base64Image = $"data:image/jpeg;base64,{Convert.ToBase64String(bytes)}";
    //         }
    //     }
    // }
    async Task SyncNow()
    {
        if (isSyncing)
            return;

        if (isSaving)
        {
            ShowError("Cannot sync while saving.");
            return;
        }

        await Auth.GetApiToken();
        await Auth.RestoreApiTokenAsync();

        isSyncing = true;
        error = "";
        success = "";
        StateHasChanged();
        try
        {
            await using var Db = await DbFactory.CreateDbContextAsync();
            // BranchId should already be in LocalSetting
            var setting = await Db.LocalSettings.FirstAsync();

            // 🔄 ORDER MATTERS

            //await SyncService.SyncSalesToServerAsync();

            await SyncService.SyncSalesAsync(setting.BranchId);

            await SyncService.SyncProductGroupsAsync();
            await SyncService.SyncProductsAsync(setting.BranchId);
            await SyncService.SyncExpenses();
            await SyncService.SyncStockAsync(setting.BranchId);
            await SyncService.DownloadUpdatedSalesAsync();




            await LoadProductGroups();
            await LoadProducts();
            await LoadExpenses();

            ShowSuccess($"Sync completed successfully");

            //success = "Sync completed successfully";
        }
        catch (Exception ex)
        {
            ShowError($"Sync failed: {ex.Message}");
        }
        finally
        {
            isSyncing = false;
            StateHasChanged();
        }
    }
    void SelectCartItem(CartItem item)
    {
        selectedItem = item;
    }

    void OnAuthStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    public void Dispose()
    {
        Auth.AuthStateChanged -= OnAuthStateChanged;
        Scale.Stop();
    }
    void SelectGroup(Guid groupId)
    {
        selectedGroupId = groupId;
        productSearch = "";
        StateHasChanged();
    }

    string GetGroupClass(Guid groupId)
    {
        return selectedGroupId == groupId ? "active" : "";
    }

    // ================= INIT =================
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!Auth.IsInitialized)
            return;

        if (Auth.CurrentUser == null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        if (firstRender)
        {
            await JS.InvokeVoidAsync("blazorFocus", paymentModeRef);
            // billNo = await BillNoService.PeekNextBillNoAsync();

            // productGroups = await Db.LocalProductGroups.Where(p => p.IsActive).ToListAsync();

            // products = await Db.LocalProducts
            //     .Where(p => p.IsActive)
            //     .ToListAsync();

            // await LoadExpenses();
            // StateHasChanged();
        }
    }


    async Task Logout()
    {
        await Auth.LogoutAsync();
        Nav.NavigateTo("/login");
    }
    async Task LoadExpenses()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        var _localExpenses = await Db.LocalExpenseMaster.Where(e => e.IsActive)
                            .Select(e => new ExpenseVm
                            {
                                ExpenseId = e.Id,
                                ExpenseName = e.ExpenseName,
                                RateType = e.RateType,
                                Rate = e.Rate,
                                Bearer = e.Bearer,
                                AddDeduct = e.AddDeduct
                            }).ToListAsync();

        expenses = _localExpenses;
        // var apiExpenses = await Api.GetSaleExpensesAsync();

        // expenses = apiExpenses.Select(e => new ExpenseVm
        // {
        //     ExpenseId = e.Id,
        //     ExpenseName = e.ExpenseName,
        //     RateType = e.RateType,
        //     Rate = e.Rate,
        //     Bearer = e.Bearer
        // }).ToList();
    }

    void RecalculateExpenses()
    {
        var productSubTotal = cart.Sum(x => x.Amount);
        var totalQty = cart.Sum(x => x.Qty);

        foreach (var exp in expenses)
        {
            if (!exp.IsSelected)
            {
                exp.CalculatedAmount = 0;
                continue;
            }

            decimal amount;
            int sign = 1;//exp.AddDeduct.ToUpper() == "ADD" ? 1 : -1;

            if (exp.RateType == "%")
            {
                amount = sign * (productSubTotal * exp.Rate / 100);
            }
            else if (exp.RateType == "@")
            {
                amount = sign * (totalQty * exp.Rate);
            }
            else // %
            {
                amount = sign * exp.Rate;
            }

            // Always store positive amount
            exp.CalculatedAmount = Math.Round(amount, 2);

        }
    }

    // ================= CART LOGIC =================
    async Task AddToCart(LocalProduct product)
    {
        var existing = cart.FirstOrDefault(x => x.ProductId == product.ProductId);

        if (product.UnitId == Guid.Empty || product.SecondaryUnitId == null)
        {
            ShowError("Product unit are not updated, please update first");
            return;
        }

        var _availableUnits = new List<UnitDto>();
        if (product.UnitId == product.SecondaryUnitId)
        {
            _availableUnits.Add(new UnitDto
            {
                Id = product.UnitId,
                UnitCode = product.PrimaryUnitName
            });
        }
        else if (product.UnitId != product.SecondaryUnitId)
        {
            _availableUnits.Add(new UnitDto
            {
                Id = product.UnitId,
                UnitCode = product.PrimaryUnitName
            });
            _availableUnits.Add(new UnitDto
            {
                Id = product.SecondaryUnitId.Value,
                UnitCode = product.SecondaryUnitName
            });
        }

        if (product.UseWeighingScale)
        {
            var result = await DialogService.OpenAsync<WeightDialog>(
            "Weight",
            new Dictionary<string, object>(),
            new DialogOptions
            {
                Width = "300px",
                CloseDialogOnOverlayClick = false
            });

            if (result == null)
                return;

            var _qty = (decimal)result;

            if (existing != null)
            {
                existing.Qty += _qty;
            }
            else
            {
                cart.Add(new CartItem
                {
                    ProductId = product.ProductId,
                    ProductName = product.ProductName,
                    UnitCode = product.UnitCode,
                    DecimalAllowed = product.DecimalAllowed,
                    Qty = _qty,
                    Mrp = product.Mrp,
                    Discount = product.Discount,
                    Rate = product.SalePrice,
                    PrimaryUnitSelected = false,
                    UnitConversionRatio = product.UnitConversionRatio,
                    GstPercent = product.GstPercent,
                    UseWeighingScale = product.UseWeighingScale,
                    UnitId = product.SecondaryUnitId.Value,
                    AvailableUnits = _availableUnits
                });
            }
        }
        else
        {
            if (existing != null)
            {
                existing.Qty += 1;
            }
            else
            {
                cart.Add(new CartItem
                {
                    ProductId = product.ProductId,
                    ProductName = product.ProductName,
                    UnitCode = product.UnitCode,
                    DecimalAllowed = product.DecimalAllowed,
                    Qty = 1,
                    Mrp = product.Mrp,
                    Discount = product.Discount,
                    Rate = product.SalePrice,
                    PrimaryUnitSelected = false,
                    UnitConversionRatio = product.UnitConversionRatio,
                    GstPercent = product.GstPercent,
                    UseWeighingScale = product.UseWeighingScale,
                    UnitId = product.SecondaryUnitId.Value,
                    AvailableUnits = _availableUnits

                });
            }
        }



        RecalculateExpenses();
    }

    void OnUnitChanged(CartItem item)
    {

        var _selectedProduct = products.Where(p => p.ProductId == item.ProductId).FirstOrDefault();
        if (_selectedProduct != null)
        {
            if (item.UnitId == _selectedProduct.UnitId)               
            {
                item.PrimaryUnitSelected = true;
                item.Rate = Math.Round((_selectedProduct.SalePrice * _selectedProduct.UnitConversionRatio), 2);
            }
            else
            {
                item.PrimaryUnitSelected = false;
                item.Rate = Math.Round(_selectedProduct.SalePrice, 2);
            }
        }




    }

    void UpdateQty(CartItem item, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var qty))
        {
            if (!item.DecimalAllowed)
                qty = Math.Floor(qty);

            item.Qty = qty;
        }
        RecalculateExpenses();
    }
    void UpdateRate(CartItem item, ChangeEventArgs e)
    {
        if (decimal.TryParse(e.Value?.ToString(), out var rate))
        {
            if (!item.DecimalAllowed)
                rate = Math.Floor(rate);

            item.Rate = rate;
        }
        RecalculateExpenses();
    }

    async Task SaveBill()
    {
        if (isSaving)
            return;

        if (isSyncing)
        {
            ShowError("Cannot save while syncing.");
            return;
        }
        isSaving = true;

        try
        {
            if (saleDate == null)
            {
                ShowError("Select Date");
                return;
            }
            if (string.IsNullOrWhiteSpace(paymentMode))
            {
                await JS.InvokeVoidAsync("blazorFocus", paymentModeRef);
                ShowError("Salect Payment Mode");
                return;
            }
            if (string.IsNullOrWhiteSpace(customerMobile))
            {
                await JS.InvokeVoidAsync("blazorFocus", customerMobileRef);
                ShowError("Enter Customer Mobile");
                return;
            }
            if (string.IsNullOrWhiteSpace(customerName))
            {
                await JS.InvokeVoidAsync("blazorFocus", customerNameRef);
                ShowError("Enter Customer Name");
                return;
            }
            if (!cart.Any())
            {
                ShowError("Cart is empty");
                return;
            }

            // Prepare selected expenses
            var saleExpenses = expenses
                .Where(x => x.IsSelected)
                .Select(x => new LocalSaleExpense
                {
                    ExpenseId = x.ExpenseId,
                    ExpenseName = x.ExpenseName,
                    RateType = x.RateType,
                    Rate = x.Rate,
                    Amount = x.CalculatedAmount,
                    Bearer = x.Bearer,
                    AddDeduct = x.AddDeduct
                })
                .ToList();

            // Call service
            var saleId = await SaleService.SaveSaleAsync(
                cart,
                saleExpenses,
                paymentMode,
                customerMobile,
                customerName
            );

            // Reset UI

            expenses.ForEach(e =>
            {
                e.IsSelected = false;
                e.CalculatedAmount = 0;
            });

            customerMobile = "";
            customerName = "";
            paymentMode = "";

            // Generate next bill number
            billNo = await BillNoService.PeekNextBillNoAsync();

            ShowSuccess($"Bill saved successfully (Sale #{saleId})");

            foreach (var item in cart)
            {
                decimal _qtyToCheck = item.PrimaryUnitSelected ? Math.Round(item.Qty * item.UnitConversionRatio, 2) : item.Qty;
                var prod = products.FirstOrDefault(p => p.ProductId == item.ProductId);
                if (prod != null)
                    prod.AvailableQty -= _qtyToCheck;
            }
            cart.Clear();
            //Nav.NavigateTo($"/receipt/{saleId}", true);
            //await ReceiptPrinter.PrintAsync(saleId);

            _ = Task.Run(async () =>
                {
                    try
                    {
                        await ReceiptPrinter.PrintAsync(saleId);
                    }
                    catch
                    {
                        await InvokeAsync(() =>
                        {
                            ShowError("Printer error");
                        });
                    }
                });



            // var printTask = ReceiptPrinter.PrintAsync(saleId);

            // if (await Task.WhenAny(printTask, Task.Delay(5000)) != printTask)
            // {
            //     ShowError("Printer not responding");
            // }


            // await JS.InvokeVoidAsync(
            //         "printReceipt",
            //         $"/receipt/{saleId}"
            //     );
            await JS.InvokeVoidAsync("blazorFocus", paymentModeRef);
        }
        catch (Exception ex)
        {
            ShowError(ex.Message);
        }
        finally
        {
            isSaving = false;
        }
    }

    void HandleKeyDown(KeyboardEventArgs e)
    {
        if (showMobileSuggestions && mobileSuggestions.Any())
        {
            if (e.Key == "ArrowDown")
            {
                selectedSuggestionIndex++;
                if (selectedSuggestionIndex >= mobileSuggestions.Count)
                    selectedSuggestionIndex = 0;

                StateHasChanged();
                return;
            }

            if (e.Key == "ArrowUp")
            {
                selectedSuggestionIndex--;
                if (selectedSuggestionIndex < 0)
                    selectedSuggestionIndex = mobileSuggestions.Count - 1;

                StateHasChanged();
                return;
            }

            if (e.Key == "Enter")
            {
                if (selectedSuggestionIndex >= 0 &&
                    selectedSuggestionIndex < mobileSuggestions.Count)
                {
                    var s = mobileSuggestions[selectedSuggestionIndex];
                    SelectMobileSuggestion(s.Mobile, s.Name);
                }

                return;
            }

            if (e.Key == "Escape")
            {
                showMobileSuggestions = false;
                selectedSuggestionIndex = -1;
                StateHasChanged();
                return;
            }
        }

        if (isSyncing || isInputFocused)
            return;
        if (e.Key == "F3")
        {
            _ = JS.InvokeVoidAsync("blazorFocus", productSearchRef);
            return;
        }
        if (e.Key == "Escape")
        {
            productSearch = "";
            StateHasChanged();
            return;
        }

        if (e.Key == "F2")
        {
            _ = SaveBill();
        }

        if (selectedItem == null)
            return;

        if (e.Key == "+")
        {
            selectedItem.Qty += 1;
        }
        else if (e.Key == "-")
        {
            selectedItem.Qty = Math.Max(1, selectedItem.Qty - 1);
        }
        else if (e.Key == "Delete")
        {
            cart.Remove(selectedItem);
            selectedItem = null;
        }





        StateHasChanged();
    }

    string GetProductImageUrl(LocalProduct p)
    {
        if (string.IsNullOrEmpty(p.ImagePath))
            return "/images/no-image.png";

        var bytes = File.ReadAllBytes(p.ImagePath);
        var base64 = Convert.ToBase64String(bytes);

        return $"data:image/jpeg;base64,{base64}";

        //return p.ImagePath;
        //return $"file:///{p.ImagePath.Replace("\\", "/")}";
    }



    void ShowSuccess(string message)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Success",
            Detail = message,
            Duration = 2000
        });
    }
    void ShowError(string message)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = "Error",
            Detail = message,
            Duration = 4000
        });
    }


    decimal ExpenseTotal =>
    expenses
        .Where(e => e.IsSelected)
        .Sum(e => e.Bearer == "Customer"
            ? e.CalculatedAmount
            : -e.CalculatedAmount);

    decimal GrandTotal =>
        cart.Sum(x => x.LineTotal) + ExpenseTotal;
}
